<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Completar Oración</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="icons/favicon.png" />
</head>
<body>
    <div data-include="header"></div>

    <main class="wrap">
        <section class="cloze-module">
            <h2 id="moduleTitle"></h2>
            <div class="cloze-grid" id="clozeContainer"></div>
            <div class="cloze-actions">
                <button id="checkAnswersBtn" class="btn-complete">Verificar Respuestas</button>
                <button id="resetBtn" class="btn-reset">Reiniciar</button>
            </div>
            <div id="feedback" class="feedback-message"></div>
        </section>
    </main>

    <div data-include="footer"></div>

    <script src="js/progress.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/style.js"></script>
    <script>
        let questions = [];

        async function loadCourse() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const lang = urlParams.get('lang') || 'fr';
                const response = await fetch(`course_${lang}.json`);
                if (!response.ok) {
                    throw new Error(`No se pudo cargar el archivo course_${lang}.json`);
                }
                const course = await response.json();
                return course;
            } catch (e) {
                console.error('Error al cargar el curso:', e);
                return null;
            }
        }

        function createClozeSentence(questionText) {
            const sentenceDiv = document.createElement('div');
            sentenceDiv.className = 'cloze-sentence';
            
            const parts = questionText.split('[...]');
            parts.forEach((part, index) => {
                const span = document.createElement('span');
                span.textContent = part;
                sentenceDiv.appendChild(span);

                if (index < parts.length - 1) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'cloze-input';
                    input.placeholder = '...';
                    sentenceDiv.appendChild(input);
                }
            });
            return sentenceDiv;
        }

        function renderQuestions() {
            const container = document.getElementById('clozeContainer');
            container.innerHTML = '';
            questions.forEach(q => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cloze-item';
                itemDiv.appendChild(createClozeSentence(q.text));
                container.appendChild(itemDiv);
            });
        }

        function checkAnswers() {
            const feedbackDiv = document.getElementById('feedback');
            let correctCount = 0;
            const inputs = document.querySelectorAll('.cloze-input');

            inputs.forEach((input, index) => {
                const correctAnswer = questions[index].answers[0]; // Asume una sola respuesta correcta por ahora
                const userAnswer = input.value.trim();
                input.classList.remove('correct', 'incorrect');
                input.disabled = true;

                if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    input.classList.add('correct');
                    correctCount++;
                } else {
                    input.classList.add('incorrect');
                }
            });

            const totalQuestions = questions.length;
            const score = (correctCount / totalQuestions) * 100;
            
            if (score >= 60) { // Límite de aprobación
                feedbackDiv.textContent = `¡Felicidades! Has aprobado con un ${score.toFixed(0)}%. ✅`;
                feedbackDiv.className = 'feedback-message success';
                Progress.saveModuleState(moduleId, score.toFixed(0), true);
            } else {
                feedbackDiv.textContent = `Necesitas completar el 100%. Obtuviste ${score.toFixed(0)}%. ❌`;
                feedbackDiv.className = 'feedback-message error';
                Progress.saveModuleState(moduleId, score.toFixed(0), false);
            }
        }

        function resetModule() {
            const feedbackDiv = document.getElementById('feedback');
            const inputs = document.querySelectorAll('.cloze-input');
            inputs.forEach(input => {
                input.value = '';
                input.disabled = false;
                input.classList.remove('correct', 'incorrect');
            });
            feedbackDiv.textContent = '';
            feedbackDiv.className = 'feedback-message';
            Progress.saveModuleState(moduleId, 0, false);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const moduleId = urlParams.get('mod');
            const moduleTitleEl = document.getElementById('moduleTitle');
            const checkAnswersBtn = document.getElementById('checkAnswersBtn');
            const resetBtn = document.getElementById('resetBtn');

            if (!moduleId) {
                moduleTitleEl.textContent = 'Error: ID de módulo no especificado.';
                return;
            }

            const course = await loadCourse();
            if (course) {
                const module = course.modules.find(m => m.id === moduleId && m.type === 'cloze');
                if (module) {
                    // Actualiza el título de la página y el <h2> de la sección
                    document.title = module.name;
                    moduleTitleEl.textContent = module.name;
                    questions = module.questions;
                    renderQuestions();
                } else {
                    moduleTitleEl.textContent = 'Error: Módulo no encontrado.';
                }
            }

            checkAnswersBtn.addEventListener('click', checkAnswers);
            resetBtn.addEventListener('click', resetModule);
        });
    </script>
</body>
</html>