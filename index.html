<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="pageTitle">Plataforma de Idiomas</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="icons/favicon.png" />
</head>
<body>
  <div data-include="header"></div> <main class="wrap">
    <section class="dashboard">
      <h2>Tu progreso</h2>
      <div class="progress-bar">
        <div class="progress-fill" id="globalProgressFill"></div>
      </div>
      <p id="globalProgressText">0% completado</p>
    </section>

    <section class="modules">
      <h2>Módulos pendientes</h2>
      <div id="modulesGrid" class="modules-grid"></div>
    </section>

    <section id="completedSection">
      <h2>Módulos completados</h2>
      <p>Aún no has completado ningún módulo. ¡Comienza ahora!</p>
      <div id="completedGrid" class="modules-grid"></div>
    </section>
  </main>

  <div data-include="footer"></div> <script src="js/progress.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/style.js"></script>
  <script>
    async function loadCourse() {
      try {
        const currentLang = localStorage.getItem('courseLang') || 'fr';
        const response = await fetch(`course_${currentLang}.json`);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      } catch (error) {
        console.error("Could not load course data:", error);
        return null;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Este bloque de código ahora se moverá al callback del fetch del header en style.js
      // para que el selector de idioma se inicialice correctamente UNA VEZ QUE EL HEADER ESTÉ CARGADO.
      // Sin embargo, la lógica de carga del curso y el llenado del título DEBE permanecer aquí.

      loadCourse().then(course => {
        if (course) {
          // Actualizar el título del sitio una vez que el header esté cargado
          const siteTitleElement = document.getElementById('siteTitle');
          if (siteTitleElement) {
              siteTitleElement.textContent = course.title;
              siteTitleElement.style.display = 'block'; // Mostrar el título
          }
          document.getElementById('pageTitle').textContent = course.title;

          const modulesGrid = document.getElementById('modulesGrid');
          const completedGrid = document.getElementById('completedGrid');

          const modulesWithState = course.modules.map(mod => {
            const state = Progress.getModuleState(mod.id);
            return {
              id: mod.id,
              name: mod.name,
              type: mod.type,
              thumbnail: mod.thumbnail ?? '',
              completed: !!state?.completed,
              score: state?.score ?? null
            };
          });

          UI.renderModulesSeparated(modulesWithState, modulesGrid, completedGrid);

          const completedModules = modulesWithState.filter(mod => mod.completed);
          const completedCount = completedModules.length;
          const totalCount = course.modules.length;
          const completedDesc = completedCount > 0
              ? `Has completado ${completedCount} de ${totalCount} módulos. ¡Sigue así!`
              : 'Aún no has completado ningún módulo. ¡Comienza ahora!';
          document.querySelector('#completedSection p').textContent = completedDesc;

          const { completed, total, totalPercent } = Progress.getGlobalProgress(course);
          document.getElementById('globalProgressText').textContent =
              `${completed} de ${total} módulos completados (${totalPercent}%)`;
          document.getElementById('globalProgressFill').style.width = totalPercent + '%';
        }
      });
    });
  </script>
</body>
</html>