<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="pageTitle">Plataforma de Idiomas</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="site-header">
    <h1 id="siteTitle"></h1>
    <nav class="top-nav">
      <a href="index.html" class="active">Inicio</a>
      <div class="lang-selector-container">
        <label for="lang-select">Idioma:</label>
        <select id="lang-select">
          <option value="fr">Francés</option>
          <option value="en">Inglés</option>
        </select>
      </div>
    </nav>
  </header>

  <main class="wrap">
    <section class="dashboard">
      <h2>Tu progreso</h2>
      <div class="progress-bar">
        <div class="progress-fill" id="globalProgressFill"></div>
      </div>
      <p id="globalProgressText">0% completado</p>
    </section>

    <section class="modules">
      <h2>Módulos pendientes</h2>
      <div id="modulesGrid" class="modules-grid"></div>
    </section>

    <section id="completedSection">
      <h2>Módulos completados</h2>
      <p>Has completado 0 de 0 módulos. ¡Sigue así!</p>
      <div id="completedGrid" class="modules-grid"></div>
    </section>
  </main>

  
  <footer class="site-footer">
    <small class="footer-text">
      <a class="github-link" href="https://github.com/maltl00r/aprende-idiomas" target="_blank">
        <svg class="github-icon" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 0c-4.42 0-8 3.58-8 8a8.01 8.01 0 005.45 7.59c.2.04.27-.09.27-.2v-1.55c-2.34.5-2.83-1.1-2.83-1.1-.38-.96-.93-1.22-.93-1.22-.76-.52.06-.5.06-.5.84.06 1.28.87 1.28.87.75 1.29 1.97.92 2.45.7.08-.55.29-.92.53-1.12-1.87-.2-3.84-.94-3.84-4.17 0-.92.33-1.67.87-2.26-.09-.2-.38-1.07.08-2.23 0 0 .7-.23 2.3.87.66-.18 1.32-.27 2-.27.68 0 1.34.09 2 .27 1.6-1.1 2.3-.87 2.3-.87.46 1.16.17 2.03.08 2.23.54.59.87 1.34.87 2.26 0 3.23-1.97 3.96-3.85 4.16.3.26.58.7.58 1.42v2.05c0 .11.08.24.27.2A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"/>
        </svg>
        <span>Código fuente</span>
      </a>
    </small>
  </footer>

  <script src="js/progress.js"></script>
  <script src="js/ui.js"></script>
  <script>
    async function loadCourse(lang) {
      try {
        const response = await fetch(`course_${lang}.json`);
        if (!response.ok) {
          throw new Error(`No se pudo cargar el archivo course_${lang}.json`);
        }
        const course = await response.json();
        return course;
      } catch (e) {
        console.error('Error al cargar el curso:', e);
        return null;
      }
    }

    function updateModuleLinks() {
        const lang = localStorage.getItem('courseLang') || 'fr';
        const moduleCards = document.querySelectorAll('.module-card a');
        moduleCards.forEach(a => {
            const currentHref = a.getAttribute('href');
            if (currentHref && currentHref.includes('?')) {
                const url = new URL(a.href);
                url.searchParams.set('lang', lang);
                a.href = url.toString();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const langSelect = document.getElementById('lang-select');
      const savedLang = localStorage.getItem('courseLang') || 'fr';
      langSelect.value = savedLang;
      document.getElementById('siteTitle').textContent = `Curso de ${savedLang === 'fr' ? 'Francés' : 'Inglés'}`;

      langSelect.addEventListener('change', (e) => {
        const newLang = e.target.value;
        localStorage.setItem('courseLang', newLang);
        window.location.reload();
      });

      loadCourse(savedLang).then(course => {
        if (course) {
          const modulesGrid = document.getElementById('modulesGrid');
          const completedGrid = document.getElementById('completedGrid');

          const modulesWithState = course.modules.map(mod => {
            const state = Progress.getModuleState(mod.id);
            return {
              id: mod.id,
              name: mod.name,
              type: mod.type,
              thumbnail: mod.thumbnail ?? '',
              completed: !!state?.completed,
              score: state?.score ?? null
            };
          });

          UI.renderModulesSeparated(modulesWithState, modulesGrid, completedGrid);

          const completedModules = modulesWithState.filter(mod => mod.completed);
          const completedCount = completedModules.length;
          const totalCount = course.modules.length;
          const completedDesc = completedCount > 0
              ? `Has completado ${completedCount} de ${totalCount} módulos. ¡Sigue así!`
              : 'Aún no has completado ningún módulo. ¡Comienza ahora!';
          document.querySelector('#completedSection p').textContent = completedDesc;

          const { completed, total, totalPercent } = Progress.getGlobalProgress(course);
          document.getElementById('globalProgressText').textContent =
              `${completed} de ${total} módulos completados (${totalPercent}%)`;
          document.getElementById('globalProgressFill').style.width = totalPercent + '%';

          updateModuleLinks();
        }
      });
    });
  </script>
</body>
</html>